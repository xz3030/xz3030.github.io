---
title: 滴滴派单算法解析（一）—— 订单分配问题初探
tags: didi
categories: didi
---

# 前言

　　加入滴滴已经有超过半年的时间了。滴滴相关的新闻倒是一直不断，从补贴大战，到合并uber中国业务，再到新政、春节带来的新动荡，关注的焦点似乎一直都是在运营的手段以及政府关系等层面。除了零星的派单远、加价高的吐槽外，外界对公司中所用的技术与算法大多是漠不关心或一知半解的状态。  

　　当时加入滴滴的时候也有很多人和我说过，滴滴作为知名的本(tu)土(bao)公司，技术上肯定是落后与不重视的，多有恨铁不成钢之感。这点的确不可否认。然而，我们也确实在一点点的积累，做着一些实事。 
<center>
![](http://research.xiaojukeji.com/images/index/case_2.png)
</center>

　　于是这里首先来解答一个大家都很好奇的问题：滴滴的派单算法是什么样的？一个看似简单的问题，实际上也是有万千玄妙的呢（笑）。如果在看过之后，能引发大家的思考，并重新审视我们的工作，那便是最大的欣慰了。

　　全文共４部分。如果你只对吐槽滴滴有兴趣的话，第一、二部分就足够啦～当然如果你对技术方面，尤其是 **深度增强学习** 在滴滴派单中的应用有兴趣的话，希望你能坚持到第三、四部分的内容，我会讲一些比较深的理论知识和应用场景。

<!--more-->

---

# 简单的问题？

> ** 订单分配** 即是在系统平台中将 乘客发出的订单 分配给 在线的司机 的过程。 

　　这看似是一个非常简单的问题。聪明的你肯定早有头绪：_把我的订单分给 **最近** 的司机不就好了嘛_？

　　Bingo! 实际上目前滴滴的派单算法确实是基于 **就近分配** 的原则进行的。据我所知，目前世界上其他的竞品公司（包括Uber Global），也均是基于这个原则分单的。但是为什么又会出现派单后司机与乘客距离好几公里的情况呢？

>     
> 目前滴滴的派单算法原则是：就近分配。  
>   

---

# 实际情况是...

　　首先我们需要明确的一点是，在订单和司机 _充分密集_ 时，使用就近分配的算法得到的分配结果即为最优解。

　　这里指的_充分密集_，即订单和司机在 *时间* 和 *空间* 维度上均存在足够多的样本。换句话说，当乘客于任何时刻呼叫订单时，均能有一个就在身边的司机在线并空闲。

　　事实上，由于订单和司机在现实中并不可能充分密集，就近分单仍存在着一定的问题。当然，这也是为什么滴滴专车的平均接单距离要大于快车的原因（专车的司机和订单较快车均要少不止一个数量级）。

> 在订单和司机 _充分密集_ 时，就近分配即可达到最优解。

## 时序很重要

![](/images/demo_all_in.png)

　　好，现在让我们来举个简单的例子吧！假设上图是一个5x3的街区，你是图中帅气地招手的小红:D 显然，在这个有两名乘客和两位司机的情况下，将右下角的司机指派来接小红（就是你啦~），而让左边的司机去接左上角的乘客是最合理的选择，皆大欢喜！

　　但现实往往比想象的更复杂，在乘客和司机的匹配问题中，通常时序是一个无法忽略的问题。实际上，上图中的两名乘客和两名司机往往并不是同时出现的。

　　为了模拟现实中更容易发生的情况，我们做了一个时序分解，看一看在这段时间里发生了什么：
![](/images/demo_timegap.png)

- 在 **时间1** 上，小红打开了滴滴并叫车，形成了一个订单。此时小红周围其实 _并没有一个可以接单的司机_。
- 过了几秒钟， **时间2** 时，左边的司机结束了上一个订单的服务，正式变为了空闲司机！此时，我们的分单系统按照 _最近匹配_ 的原则，将小红的订单分给了左边的司机，小红要等待司机5分钟才能上车。
- 又过了几秒钟，右下角司机终于结束了上一单的服务姗姗来迟，然而系统已经指派了左边的司机来接单了。

　　这里也许会有很多人有疑问：上面说的是否只是我捏造的例子呢？实际上这种情况的发生比例能有多少呀？

　　很遗憾，上图所述的情况在现实中是普遍存在的。数据显示，在大城市高峰期热区地区，有超过50%的订单在产生时周围并没有空闲司机，而是在等待一段时间后分给刚刚结束服务的司机的。这种情况下，就近分配的方案可能不太好用哦T_T。

> 高峰期时，有超过50%的订单是刚刚由结束服务的司机接单的哦！  
> 在 大城市/热区/高峰期 ，这个比例甚至可能超过80%！

## 为了更多人

　　影响就近分单的第二个元素是个人需求（即 _贪婪法_ ）和更多人的需求（即 _全局最优_ ）的权衡。

![](/images/demo_greedy_vs_km.png)

　　回到刚才的例子，同样的5x3的街区，如果将靠左边的司机稍微向右移动一格，即会造成个人最优和全局最优的冲突。从小红的立场来看，自己不远处就有一辆车可以来接单。然而，若这辆车分配给了小红，另外一个乘客可能要忍受极长的接单时间，并很有可能只能 **取消订单** 。

　　面对这个两难问题，你的选择会是什么呢？

> 在供需系统中，个人利益的最优与全局最优常常是冲突的。

## 看的更远

　　相信大家一定有听说过或经历过出租车司机拒载的情况，其根本原因，在于订单确实有“肥瘦”之分。与个人乘客零星的打车需求不同，司机往往会在平台上连续接单好几个小时。这时，司机考虑的不只是当前的收益，还有了未来可能的收益。

　　平台作为一个资源的调配方，其最终目的是 **服务更多的乘客/订单，使得司机的收入最高，从而提升平台收益，达到共赢的效果 **。

　　为此，当一个在高峰期前从热区开到冷区的订单发出时，平台不得不在完成这一单的收益，和让司机之后一小时都要空驶，从而使得未来本可能让这个司机接单的两个订单无人接单之间做出选择。又是一个痛苦的抉择呐。

> 春节期间由于司机减少的原因，大部分时间超过80%的快车司机都在服务中哦! 空闲的司机大多都是因为被订单派到了非常偏远的地方。

---

# 你会怎么做？

　　当站在整个平台的角度看问题的时候，世界往往会和我们预想的发生微妙的偏差。也许在读这篇文章前，我们都无从了解原来一个“简单”的派单里还有如此多的问题。关于派单，你是否有自己的意见或建议给我们呢？

　　在下一节中，我会简单地介绍目前我们对这些问题的思考以及当前的派单算法。
