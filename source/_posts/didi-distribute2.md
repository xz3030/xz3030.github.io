---
title: 滴滴派单算法解析（二）—— 线上策略
tags: didi
categories: didi
date: 2017-02-03 15:50:32
---


# 前言

　　在上一节的内容中，我们描述了派单过程中可能出现的问题。关于这些问题的应对方案，或多或少都在目前线上使用的派单策略中有所体现，并获得了一定的效果。这一节里我们就来聊聊线上的策略到底是什么样的～ (_公司政策所致，这里不能放具体的数据和太详细的策略执行情况，所以还是以motivation为主_)。

<!--more-->

---

# 总原则
> 当前派单策略的原则是 从全局出发，保证用户的需求尽可能多的被满足。

　　如上一节所说，在设计派单算法时，会涉及到一些原则或是哲学问题。在当前线上的策略中，我们的总原则是：**站在全局的角度，尽可能多服务一个用户，并尽力保证用户表达的每个叫车需求可以确定性的执行**。如何理解这个原则呢？
- 策略是站在 **全局** 的角度，争取达到全局最优。这样，对每个用户自身来说，派单可能不是“局部最优”的，但大多数用户的需求可以得到保证。
- 叫车的确定性，即用户在平台中点击呼叫后，我们希望绝大部分的用户都能有司机来响应，并最终完成订单。其分别对应 _应答率_ 和 _成交率_ 两个概念。目前，正常情况下，平台上快车的应答率超过95%，成交率超过80%。

---

# 线上策略
　　基于我们的总原则，下面一一讲一下现在线上使用（或进行过实验）的派单策略。

## 规则过滤
> 如果身边的滴滴司机没有听到你发的订单，那么他很有可能是命中了反作弊、限号等过滤规则了。若不是，请检查一下司机手机的网络状况，由于种种原因没有听到播单的情况也有超过1%哦。

　　最基本的策略其实是人工设定的规则过滤。必须澄清的一点是这里的规则并不会造成分单时不公平的效果，而完全是为了业务能正常运行而设立的。举几个最基础的例子：
- 规则A: 快车司机不能接专车订单
- 规则B: 保证司机接单后不会通过限号区域
- 规则C: 为设定实时目的地的司机过滤不顺路订单
- 规则D: 为只听预约单的司机过滤实时订单
- 规则E: 同一个订单只会发给一个司机一次
- 。。。

　　目前这些类似的为了保证业务正确性的人工规则已经有了超过60条，也同时承担着反作弊、拼车等业务的入口功能。当然，这种人工规则并不涉及到具体的派单策略，故这里就不展开讲了。


## 延迟集中分单
> 当前线上的派单系统，是将乘客订单和空闲司机的信息收集起来，每一秒钟进行一次全局最优的分单匹配。

　　派单策略中最基础的部分，是为了解决上一节提到的时序问题。

　　由于用户订单的产生和司机的出现往往并不在同一时间点，在时间维度上贪婪的分单方式（即每个订单出现时即选择附近最近的司机派单）并不能获得全局最优的效果。一个自然的想法就是先让乘客和司机稍等一会，待收集了一段时间的订单和司机信息后，再集中分配。这样，有了相对较多、较密集的订单、司机后，派单策略即可找到更近更合理的派单方式了。

　　找寻司机和订单分配的全局最优是一个 _二分图匹配问题_ (bipartite graph matching) ，可用组合优化中知名的 [_匈牙利算法_](https://en.wikipedia.org/wiki/Hungarian_algorithm) 求解。见下图。实际上，我们线上使用的是匈牙利算法的一个改进： [_Kuhn–Munkres (KM) 算法_](https://www.topcoder.com/community/data-science/data-science-tutorials/assignment-problem-and-hungarian-algorithm/)。

![](/images/km_algorithm.png)


## 基于供需预测分单
> 如果有先知告诉我们每个订单的生成时间和地点，派单就会变成一件很轻松的事情。

　　KM算法得到的匹配结果，理论上保证是全局最优的。所以问题圆满解决，可喜可贺~~~~真的是这样吗？

　　很遗憾，以上所述的延迟集中分单的策略只能解决部分的问题，仍不是一个完全的方案。其最大的问题，在于用户对系统派单的 *响应时间* 容忍度有限，很多情况下短短的几秒钟即会使用户对平台丧失信心，从而取消订单。故实际线上我们只累积了一秒钟的订单和司机信息进行集中分单，而这在大局上来说仍可近似看做时间维度上的贪婪策略。

　　若想即时的获得最优派单结果，唯一的方法是利用对未来的预测，即进行基于供需预测的分单。这种想法说来玄妙，其实核心内容也很简单：如果我们预测出未来一个区域更有可能有更多的订单/司机，那么就让这个区域的司机/订单先暂缓接单。

![](/images/density_distribute.png)

　　重新回到上一节的例子。这次我们加入了供需预测，对应于上图方框的颜色，颜色越深，代表越有可能形成新的订单。在时间1上，乘客的订单有左边和右下角两辆车均可接单，左边的司机相对来说要更近一些。但由于考虑到了未来可能产生的订单的影响，我们认为将左边的司机留下更有利于未来的订单分配，故在时间2上我们即做出决策，让右下角的司机接单。这个派单决策，直接造成了时间3上新的乘客的需求得到了响应，达到了更合理的分配效果。

## 连环派单
　　基于供需预测的分单有很大意义，但由于预测的不确定性，其实际效果很难得到保证。为此，我们使用了一种更有确定性的预测方式来进行派单，即 _连环派单_。

> 连环派单，即将订单指派给 _即将结束服务_ 的司机，如果司机的终点与订单位置很相近。

　　与预测订单的分布相反，连环派单预测的是下一时刻空闲司机的所在位置。由于高峰期空闲司机多为司机完成订单后转换而来，预测司机的位置就变成了一个相对确定性的问题，即监测司机到目的地的距离和时间。当服务中的司机距终点很近，且终点离乘客新产生的订单也很近时，便会命中连环派单逻辑。司机在结束上一单服务后，会立刻进入新订单的接单过程中，有效地压缩了订单的应答时间、以及司机的接单距离。

　　连环派单策略上线后获得了很好的效果，也说明了供需预测对订单分配的重要性。

---

# 看看真实数据是怎么样的？
　　理论上的策略终究是虚的，很容易看的一头雾水。不如现在我们来探一下线上的真实数据是怎么样的！

　　下图是北京某天早高峰 一个KM分单周期（如上文所述，为一秒钟）的订单与空闲司机分布情况。为隐私考虑，图中隐去了所有乘客和司机的个人信息和地图，目的为大致地观察一下线上的真实场景。
- 每一格为约2kmx2km的区域；
- 蓝色的圆圈表示这一轮派单中，完成分单  的订单；
- 红色的圆圈表示这一轮派单中，未完成分单 的订单；
- 绿色的小圆圈表示在这一轮派单中，所有周围有订单的空闲司机；
- 蓝色大圆圈和绿色小圆圈的连线 代表 匹配结果。
- 白色圆圈表示系统中存在的订单，但周围没有可接单的空闲司机。

![](/images/online_distribute_result.png)

　　从图中我们可以发现一些有意思的现象：
- 由于业务上过滤规则的缘故，不是所有订单都可以和所有司机匹配；
- 订单和司机的分布很不均匀，会出现大量司机很少订单（如左上角）和大量订单很少司机（如正下方和左下角）的情况；
- 即使单独在某一时刻看，分配成功的订单比例只占很低的部分，但由于不断有载客司机结束服务，实际上的订单分配成功率（即应答率）仍可超过90%。

> 现实中订单和司机的分布不均匀是普遍存在的。

---

# 总结
　　基于订单分配中的很多问题，以服务更多人为目标，数据科学家们设计了多种派单策略，并在线上实验获得了可观的效果。

　　然而，当前的派单策略更多的有种各自为政，缺乏整体感和模型化的感觉。为此，我们设计了考虑未来的增强学习模型化的派单策略，将在下两节和大家分享。

