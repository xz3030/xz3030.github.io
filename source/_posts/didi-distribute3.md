---
title: 滴滴派单算法解析（三）—— 模型化派单雏形
tags: didi
categories: didi
date: 2017-02-03 15:50:37
---


# 前言
　　模型化派单是我们近期刚刚开展的一项创新性项目。做模型化的意义很明显：这可以使我们从繁琐的人工参数设置中解放出来，真正的以 _数据驱动_ 的方式来理解并指导派单行为。

　　模型化派单的雏形，要从时空价值模型讲起。

![某时刻北京专车的时空价值示例](/images/timespace_model_vis.png)

<!--more-->

---

# 时空价值模型的来由
　　在滴滴的交易引擎中，共存在着三种形态的个体：乘客、司机、以及平台。平台的作用，即站在宏观的角度，通过调控使得更多的订单可以完成。其中，司机作为长时间存在于平台中提供服务的个体，可认为是资源的提供方。从这个角度，平台的作用即最大限度的利用已有资源（司机），使其可服务更多的订单（乘客）。

　　换句话说，平台的作用即使得平台上的司机们“忙起来”，指导其接哪些订单，向哪里调度，可以获得最多的收益。这里指的收益，不只是当前接到或未接到订单的收益，而是从长远考虑，对司机未来可能获得的总收入的一种衡量。

> 时空价值模型衡量的是平台上的某个司机，若在某个时刻（如上午8点）出现在某个区域（如中关村），那么其在一个自然天内预期可产生的总流水值（如600元）。

　　那么司机在某个时刻出现在哪个位置才更有可能获得更多收益呢？服务多年的老司机们常常会有自己的独家绝学，比如多去机场趴活跑长单，或是地铁站小区来回短单，亦或是夜高峰去商业区接晚下班的白领等等。计算每个区域/时间的价值是一个很复杂的问题，它至少与以下因素相关：
- 区域的订单量
- 区域的司机数
- 是否是高峰期
- 市中心的话是否拥堵
- 是否是机场等长单多的地方
- 是否有大企业可报销的情况
- 是否有大型活动
- 等等

　　一个完全考虑了以上所有因素的模型几乎是不可能存在的。但是如果我们换个思路，从过去所有司机的接单记录出发，是否可以绕过以上因素，直接得到司机在某个时间/区域出现的长期价值呢？答案是肯定的。

---

# 时空价值模型的计算
　　时空价值模型的计算涉及到 **增强学习(Reinforcement Learning)** 的一些基础知识，不熟悉的读者可以参考 [David Silver的公开课](http://www0.cs.ucl.ac.uk/staff/d.silver/web/Teaching.html) 以及 [Rich Sutton的书](http://webdocs.cs.ualberta.ca/~sutton/book/the-book.html)。

> 时空价值，即将司机在平台上的行为建模成一个马尔科夫决策过程(MDP)，采用动态规划(DP)的算法，计算得到的价值(Value Function)。

　　这里直观的解释一下时空价值的计算：为了衡量司机出现在某个时间/区域的价值，我们首先要考虑 _当前价值_ ，即当前状态下接单的概率及预期接单的收入；此外，我们还需考虑 _未来价值_ ，即司机接单后达到的目的地的时空价值。换句话说，我们不光希望司机当前可以更容易接单、赚钱，还会考虑这一单结束后，下一单，再下一单，再下一单，直到一天的结束的总收入。

　　聪明的读者可能已经发现了，这是一个典型的动态规划问题(Dynamic Programming)，可以高效的求解。为此，我们将平台上过去三个月的司机接单（和空闲）行为进行了精细的处理，并将其封装为了半马尔科夫决策过程(semi-Markov Decision Process)的动作(action)的四元组输入：(起始状态$S$，终止状态$S'$，收益$R$，持续时间$D$)。

　　我们首先将时间和空间进行量化，分别以十分钟和六边形格子（半径约1.5km）为最小单位。假设司机在$T_0$时刻处在区域X，对应的状态为$S_0=(T_0,X)$。

* 情况1：假设司机在10分钟内未接单。
这种情况下，认为司机从$S_0$状态，经过了一个时间点，转移到了 $S_1=(T_1, X)$ 状态，并且没有得到任何收益( $R=0$ )，如下图所示。
![](/images/tsm_wait.png)
故状态$S_0$的价值会受到一定的损失，使其更接近于一个时间点后的状态($S_1$)的价值：
$$ V(S_0) \leftarrow V(S_1) $$

* 情况2：假设司机接到了订单$O$，订单的终点在区域$Y$，行驶了20分钟，于时间$T_3$到达终点。
这种情况下，司机从$S_0$状态出发，发生了到$S_2=(T_3, Y)$状态的转移，并获得了订单金额$R=R_O$的收益。
![](/images/tsm_order.png)
状态$S_0$的价值同样会发生变化，会更接近于订单固有价值$R_O$和订单终点价值$V(S_2)$的和。这里需要注意的一点是，即使司机接到了订单，但由于订单的终点可能是冷区（价值很低），状态$S_0$的价值反而也有可能会降低。
$$ V(S_0) \leftarrow V(S_2) + R_O $$

　　考虑了空闲和接单两种情况，以及排除了司机出车/收车以及预约单的影响，我们得到了百万级别的出行数据，并使用动态规划的算法算出了每个时间/空间状态的价值。题图即显示了北京某时刻所有区域的价值分布。


---

# 时空价值模型的应用
　　时空价值模型可用来指导订单分配、司机调度等任务。直观地，我们希望司机向着更容易接单，即时空价值较高的区域集中。同时，使用计算出的时空价值，我们可以量化的设定任何时间/区域的最优播单距离（即司机和乘客间距离的最远阈值）、平衡距离和供需间的不平衡等。

　　目前时空价值模型已经成功的应用于快车订单升舱（即快车单会有一定概率免费享受专车司机的服务哦）中，使得完成订单后专车司机的位置更佳，从而提高了专车司机的收入。

> 时空价值模型首先应用于智能升舱中，提升了专车司机的收入，最高的城市有接近10%的幅度哦！

---

# 结论
　　时空价值模型是向模型化分单转化的第一步，它将各种因素统一转变为了司机的收入，从而使得长时间（如一整天）的全局最优化策略变为可行。

　　然而，虽然时空价值模型从真实的历史数据出发，使用了全部司机的接单记录，但其考虑的是单个司机的价值最优化，与整体派单系统的目标稍有偏差。在下一节中，我们将抛砖引玉，提出全局考虑多达上万个司机整体效率最优化算法的主要思路。

